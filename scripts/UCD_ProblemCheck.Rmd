---
title: "UCD_ProblemCheck"
author: "Brandie QC"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Code for checking for problems in data

## Annual Census
```{r}
#load the libraries
library(tidyverse)

data <- read_csv("../input/UCD2023_2024_Data/CorrectedCSVs/UCD_annual_census_20240718_corrected.csv")
  #remove spaces in column names
  names(data) <- gsub(" ", "", colnames(data))
  
  #check for spaces in numbers
  data2 <- data %>% filter(grepl(" ", diam.mm) | grepl(" ", num.flw) | grepl(" ", num.fruitordate.collected) | 
                             grepl(" ", long.fruit.cm) | grepl(" ", total.branch) | 
                             grepl(" ", overhd.diam) | grepl(" ", overhd.perp)) %>%
    mutate(problem="spaces")
  
  #check for extreme values
  data3 <- data %>% mutate(diam.mm=as.numeric(diam.mm), long.fruit.cm=as.numeric(long.fruit.cm))
  data3 <- data3 %>% filter(diam.mm > 50, long.fruit.cm > 15) %>% mutate(problem="extreme value")
  
  #check for letters in number columns 
  data4 <- data %>% rowwise() %>% filter(!is.na(diam.mm)) %>% filter(is.na(as.numeric(diam.mm))) %>%
    mutate(problem="character")
  data6 <- data %>% rowwise() %>% filter(!is.na(total.branch)) %>% filter(is.na(as.numeric(total.branch))) %>%
    mutate(problem="character")
  data8 <- data %>% rowwise() %>% filter(!is.na(num.flw)) %>% filter(is.na(as.numeric(num.flw))) %>%
    mutate(problem="character")
  data10 <- data %>% rowwise() %>% filter(!is.na(long.fruit.cm)) %>% filter(is.na(as.numeric(long.fruit.cm))) %>%
    mutate(problem="character")
  data11 <- data %>% rowwise() %>% filter(!is.na(overhd.diam)) %>% filter(is.na(as.numeric(overhd.diam))) %>%
    mutate(problem="character")
  data12 <- data %>% rowwise() %>% filter(!is.na(overhd.perp)) %>% filter(is.na(as.numeric(overhd.perp))) %>%
    mutate(problem="character")
  
  #combine into one problems list
  data_probs <- rbind(data2, data3, data4, data6, data8, data11, data12)
  data_probs
  write_csv(data_probs, "../output/UCD_Traits/anncens_probs.csv")
```

## Mortality
```{r}
#load the libraries
library(tidyverse)
#tutorial at https://bookdown.org/ansellbr/WEHI_tidyR_course_book/week-4-part-3.html
data_files <- list.files('../input/UCD2023_2024_Data/CorrectedCSVs/',pattern='mort.*corrected.*csv',ignore.case=TRUE)  #edit this to be correct path 
data_files #make this specific to mortality or size

data_names <- str_remove(data_files, pattern = ".csv")
data_names

for (i in data_names) {
  #set up variable file names
  in_file <- paste("../input/UCD2023_2024_Data/CorrectedCSVs/", i, '.csv', sep = "")   #edit this to be correct path 
  out_table <- paste("../output/UCD_Traits/", i, '_dataprobs.csv', sep="")
  
  #data checking code
  data <- read_csv(in_file)
  
  #remove spaces in column names
  names(data) <- gsub(" ", "", colnames(data))
  
  #check for spaces in numbers
  data2 <- data %>% filter(grepl(" ", bud.date) | grepl(" ", flower.date) | grepl(" ", fruit.date) | grepl(" ", last.FL.date) | grepl(" ", last.FR.date) | grepl(" ", death.date)) %>% mutate(problem="spaces")
  
  #check for non-date format
  data5 <- data %>% rowwise() %>% filter(!is.na(bud.date)) %>% 
    filter(is.na(mdy(bud.date))) %>% 
    mutate(problem="non-date")
  
  data6 <- data %>% rowwise() %>% filter(!is.na(flower.date)) %>% 
    filter(is.na(mdy(flower.date))) %>% 
    mutate(problem="non-date")
  
  data7 <- data %>% rowwise() %>% filter(!is.na(fruit.date)) %>% 
    filter(is.na(mdy(fruit.date))) %>% 
    mutate(problem="non-date")
  
  data8 <- data %>% rowwise() %>% filter(!is.na(last.FL.date)) %>% 
    filter(is.na(mdy(last.FL.date))) %>% 
    mutate(problem="non-date")
  
  data9 <- data %>% rowwise() %>% filter(!is.na(last.FR.date)) %>% 
    filter(is.na(mdy(last.FR.date))) %>% 
    mutate(problem="non-date")
  
  data10 <- data %>% rowwise() %>% filter(!is.na(death.date)) %>% 
    filter(is.na(mdy(death.date))) %>% 
    mutate(problem="non-date")
  
  #combine into one problems list
  data_probs <- bind_rows(data2, data5, data6, data7, data8, data9, data10)
  print(nrow(data_probs))
  write_csv(data_probs, path=out_table)
}
```

## Size Data - basic check 
```{r}
#load the libraries
library(tidyverse)
#tutorial at https://bookdown.org/ansellbr/WEHI_tidyR_course_book/week-4-part-3.html
data_files <- list.files('../input/UCD2023_2024_Data/CorrectedCSVs/',pattern='UCD_size.*corrected.*csv',ignore.case=TRUE)  #edit this to be correct path 
data_files #make this specific to mortality or size

data_names <- str_remove(data_files, pattern = ".csv")
data_names

for (i in data_names) {
  #set up variable file names
  in_file <- paste("../input/UCD2023_2024_Data/CorrectedCSVs/", i, '.csv', sep = "")   #edit this to be correct path 
  out_table <- paste("../output/UCD_Traits/", i, '_dataprobs.csv', sep="")
  
  #data checking code
  data <- read_csv(in_file)
  
  #remove spaces in column names
  names(data) <- gsub(" ", "", colnames(data))
  
  #check for spaces in numbers
  data2 <- data %>% filter(grepl(" ", height.cm)) %>% 
    mutate(problem="spaces", , height.cm=as.character(height.cm))
  
  #check for extreme values
  data3 <- data %>% mutate(height.cm=as.double(height.cm))
  data3 <- data3 %>% filter(height.cm>200) %>% 
    mutate(problem="extreme value", height.cm=as.character(height.cm))
  
  #check for spread out data 
  data4 <- data
  data4 <- data4 %>% mutate(herbiv.y.n = na_if(herbiv.y.n, "N/A")) %>% mutate(herbiv.y.n = na_if(herbiv.y.n, "-"))
  data4$herbiv.y.n <- str_to_upper(data4$herbiv.y.n)
  data4 <- data4 %>% filter(herbiv.y.n != "Y" & herbiv.y.n != "N") %>% 
    mutate(problem="herbiv col", height.cm=as.character(height.cm))
  
  #check for letters in number columns 
  data5 <- data %>% rowwise() %>% filter(!is.na(height.cm) & height.cm !="-" & height.cm != "N/A") %>% 
    filter(is.na(as.numeric(height.cm))) %>% 
    mutate(problem="character", , height.cm=as.character(height.cm))
  
  #combine into one problems list
  data_probs <- bind_rows(data2, data3, data4, data5)
  print(nrow(data_probs))
  write_csv(data_probs, path=out_table)
}
```


## Size Data (temporal check)
Check for data when there is no data in previous week 
* Reason: found a case where someone wrote the data in the wrong row (in the row of a dead plant) 

```{r}
library(tidyverse)

files <- dir("../input/UCD2023_2024_Data/CorrectedCSVs/",
             pattern="UCD_size",
             full.names=TRUE)
files #list of files 

dat <- tibble(path=files, filename=basename(path)) #storing data in tibble
dat

# create a new column, "date"
dat2 <- dat %>%
  mutate(survey_date=str_extract(filename, "_2[0-9]*"), 
         survey_date=str_remove(survey_date, "_"), 
         survey_date=lubridate::ymd(survey_date))
dat2
```

### read in the files 
```{r}
dat3 <- dat2 %>% 
  mutate(sheets=map(path, 
                    read_csv, 
                    col_types=cols(.default=col_character()), # forces all columns to be character
    # this is needed because of data sheet problems that cause some numerics to be imported as character  
                    na = c("", "NA", "-", "N/A") # sets NA strings.
                    )) %>%
  select(-path)

#dat3$sheets[[1]] # extract the first imported sheet to check that the above worked

map(dat3$sheets, colnames) %>% #check column names before merging 
  unlist() %>%
  unique() %>%
  sort()
#have some extra columns ("...10" and "...9")

map(dat3$sheets, head,10) #see which ones have extra columns 
dat3$sheets[[1]] %>% filter(!is.na(...10)) #extra notes 
dat3$sheets[[7]] %>% filter(!is.na(...10)) #extra notes 
```

### Unnest 
```{r}
#unnest
dat4 <- dat3 %>% unnest(sheets) %>% 
  select(filename, survey_date, bed:col, unique.ID, height.cm:long.leaf.cm, survey.notes)
head(dat4)
names(dat4)
```

### check for data issues
```{r}
uniqueID_probs <- dat4 %>% rowwise() %>% 
  filter(!is.na(unique.ID)) %>% 
  filter(unique.ID!="buffer") %>% 
  filter(is.na(as.numeric(unique.ID)) | str_detect(unique.ID, "\\.")) %>% #SOME ISSUES 
  mutate(problems="uniqueID column")
write_csv(uniqueID_probs, "../output/UCD_Traits/uniqueID_probs.csv")

row_probs <- dat4 %>% rowwise() %>% 
  filter(!is.na(row)) %>% 
  filter(is.na(as.numeric(row))) %>% #SOME ISSUES 
  mutate(problems="row column")
write_csv(row_probs, "../output/UCD_Traits/row_probs.csv")

dat4 %>% rowwise() %>% filter(!is.na(height.cm)) %>% filter(is.na(as.numeric(height.cm))) #NONE

leaflngth_probs <- dat4 %>% rowwise() %>% 
  filter(!is.na(long.leaf.cm)) %>% 
  filter(is.na(as.numeric(long.leaf.cm))) %>%  #SOME ISSUES 
  mutate(problems="leaf length column")
write_csv(leaflngth_probs, "../output/UCD_Traits/leaf_length_probs.csv")

unique(dat4$bed) 
dat4 %>% filter(bed=="E'") #4/26
dat4 %>% filter(bed=="C 1") #4/19
dat4 %>% filter(bed=="c") #4/19
dat4 %>% filter(bed=="F -") #5/10
bed_probs <- dat4 %>% 
  filter(bed=="E'" | bed=="C 1" | bed=="c" | bed=="F -") %>% 
  mutate(problems="bed column")
write_csv(bed_probs, "../output/UCD_Traits/bed_probs.csv")

unique(dat4$col) 
dat4 %>% filter(col=="c") #5/3, 5/10
dat4 %>% filter(col=="C .") #2/23 
dat4 %>% filter(col=="D .") #3/25 
col_probs <- dat4 %>% 
  filter(col=="c" | col=="C ." | col=="D .") %>% 
  mutate(problems="col column")
write_csv(col_probs, "../output/UCD_Traits/col_probs.csv")
```

### lag lead function
```{r}
dat4 %>% arrange(survey_date) %>% select(survey_date) %>%  distinct() %>% pull()

dat5 <- dat4 %>% 
  filter(unique.ID!="buffer") %>% #remove buffers 
  mutate(across(c(row, long.leaf.cm, height.cm), as.numeric)) %>% 
  mutate(censusN=ifelse(survey_date=="2023-12-14", 1,
                        ifelse(survey_date=="2024-01-05", 2,
                        ifelse(survey_date=="2024-01-12", 3, 
                        ifelse(survey_date=="2024-01-19", 4, 
                        ifelse(survey_date=="2024-01-26", 5, 
                        ifelse(survey_date=="2024-02-02", 6,
                        ifelse(survey_date=="2024-02-09", 7, 
                        ifelse(survey_date=="2024-02-23", 8,
                        ifelse(survey_date=="2024-03-11", 10,
                        ifelse(survey_date=="2024-03-19", 11,
                        ifelse(survey_date=="2024-03-25", 12,
                        ifelse(survey_date=="2024-04-05", 13,
                        ifelse(survey_date=="2024-04-12", 14,
                               ifelse(survey_date=="2024-04-19", 15,
                                      ifelse(survey_date=="2024-04-26", 16,
                                             ifelse(survey_date=="2024-05-03", 17,
                                            ifelse(survey_date=="2024-05-10", 18,
                                             ifelse(survey_date=="2024-05-16", 19,
                                                                  NA)))))))))))))))))))
dat5 %>% filter(is.na(censusN)) #none 
```

### Check for data when there is no data in previous week 
*NEED TO COME BACK TO THIS AFTER FIX ABOVE DATA ISSUES 
```{r}
dat6 <- dat5 %>%  #by bed, row, col
  group_by(bed, row, col) %>% 
  mutate(previous_census_height=lag(height.cm, order_by = censusN), 
         previous_census_length=lag(long.leaf.cm, order_by = censusN)) %>% 
  select(censusN, bed, row, col, previous_census_height, height.cm, 
         previous_census_length, long.leaf.cm,
         survey.notes) %>% 
  arrange(bed, row, col, censusN)
dat8 <- dat6 %>% filter(censusN!=1) %>% filter(is.na(previous_census_height), !is.na(height.cm)) 
dim(dat8) #12 rows 


dat7 <- dat5 %>% #by uniqueID
  group_by(unique.ID) %>% 
  mutate(previous_census_height=lag(height.cm, order_by = censusN), 
         previous_census_length=lag(long.leaf.cm, order_by = censusN)) %>% 
  select(bed, row, col, survey_date,censusN,unique.ID, previous_census_height, height.cm, 
         previous_census_length, long.leaf.cm,
         survey.notes) %>% 
  arrange(unique.ID, censusN)

#Check for data when there is no data in previous week 
dat9 <- dat7 %>% filter(censusN!=1) %>% filter(is.na(previous_census_height), !is.na(height.cm)) 
dim(dat9) #8 rows 
dat9
dat8

dat5 %>% filter(unique.ID=="1093") #resprout
dat9 %>% filter(unique.ID=="160")
dat9 %>% filter(unique.ID=="196")
dat9 %>% filter(unique.ID=="2038")
dat9 %>% filter(unique.ID=="535")

#write.csv(dat9, "../output/UCD_Traits/UCD_MissingDataPrevWeek.csv", row.names = FALSE)
```
